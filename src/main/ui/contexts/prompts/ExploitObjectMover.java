package ui.contexts.prompts;

import model.GadgetCollection;
import model.ExploitObject;
import ui.contexts.ConsoleContext;
import ui.contexts.menus.CollectionEditor;

// Represents a UI context that moves an ExploitObject to a different index in the same collection
public class ExploitObjectMover extends PromptContext {
    private ExploitObject exploitObject;
    private int oldIndex;

    // EFFECTS: Creates a new ExploitObjectMover context with the given parentContext.
    //          Sets the defaultResponse to the index of the last item in parentContext.collection.
    public ExploitObjectMover(ConsoleContext parentContext) {
        super(
                parentContext,
                "Origin index",
                String.valueOf(((CollectionEditor) parentContext).getCollection().getLength() - 1)
        );
    }

    // MODIFIES: ((CollectionEditor) this.getParentContext()).getCollection()
    // EFFECTS: If no exploitObject is stored, attempt to store the object at the given index.
    //          Otherwise, attempt to insert the stored object into the collection at the index
    @Override
    public ConsoleContext handleInputInternal(String input) {
        GadgetCollection collection = ((CollectionEditor) getParentContext()).getCollection();

        if (exploitObject == null) {
            return readOrigin(collection, input);
        } else {
            return readDestination(collection, input);
        }
    }

    // MODIFIES: ((CollectionEditor) this.getParentContext()).getCollection()
    // EFFECTS: Attempts to store the exploitObject at the specified index and remove it from the collection.
    //          Returns the next context if successful, otherwise returns the parentContext.
    private ConsoleContext readOrigin(GadgetCollection collection, String input) {
        for (char c : input.toCharArray()) {
            if (!Character.isDigit(c)) {
                return getParentContext();
            }
        }

        int index = Integer.parseInt(input);

        exploitObject = collection.get(index);

        if (collection.remove(index)) {
            this.oldIndex = index;
            this.setPrompt("Destination index");
            return this;
        }

        return getParentContext();
    }

    // MODIFIES: ((CollectionEditor) this.getParentContext()).getCollection()
    // EFFECTS: Attempts to insert exploitObject in the collection at the specified index.
    //          If unsuccessful, reinserts the exploitObject at the original index.
    //          Returns the parentContext.
    private ConsoleContext readDestination(GadgetCollection collection, String input) {
        for (char c : input.toCharArray()) {
            if (!Character.isDigit(c)) {
                collection.add(exploitObject, oldIndex);
                return getParentContext();
            }
        }

        int index = Integer.parseInt(input);

        if (!collection.add(exploitObject, index)) {
            collection.add(exploitObject, oldIndex);
        }

        return getParentContext();
    }
}
