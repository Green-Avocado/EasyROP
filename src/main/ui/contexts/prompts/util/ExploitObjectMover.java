package ui.contexts.prompts.util;

import model.GadgetCollection;
import model.gadgets.ExploitObject;
import ui.contexts.ConsoleContext;
import ui.contexts.menus.CollectionEditor;
import ui.contexts.prompts.PromptContext;

// Represents a UI context that moves an ExploitObject to a different index in the same collection
public class ExploitObjectMover extends PromptContext {
    private ExploitObject exploitObject;
    private int oldIndex;

    // EFFECTS: Creates a new ExploitObjectMover context with the given parentContext.
    //          Sets the defaultResponse to the index of the last item in parentContext.collection.
    public ExploitObjectMover(ConsoleContext parentContext) {
        super(
                parentContext,
                "Origin index",
                String.valueOf(((CollectionEditor) parentContext).getCollection().getLength() - 1)
        );
    }

    // EFFECTS: Creates a new ExploitObjectMover context with the given parentContext and exploitObject.
    //          Sets the defaultResponse to the length of parentContext.collection.
    public ExploitObjectMover(ConsoleContext parentContext, ExploitObject exploitObject, int oldIndex) {
        super(
                parentContext,
                "Destination index",
                String.valueOf(((CollectionEditor) parentContext).getCollection().getLength())
        );

        this.exploitObject = exploitObject;
        this.oldIndex = oldIndex;
    }

    // REQUIRES: input can be parsed as an integer
    // MODIFIES: ((CollectionEditor) this.getParentContext()).getCollection()
    // EFFECTS: If no exploitObject is stored, attempt to store the object at the given index.
    //          Otherwise, attempt to insert the stored object into the collection at the index
    public ConsoleContext handleInputInternal(String input) {
        int index = Integer.parseInt(input);
        GadgetCollection collection = ((CollectionEditor) getParentContext()).getCollection();

        if (exploitObject == null) {
            return readOrigin(collection, index);
        } else {
            return readDestination(collection, index);
        }
    }

    // MODIFIES: ((CollectionEditor) this.getParentContext()).getCollection()
    // EFFECTS: Attempts to store the exploitObject at the specified index and remove it from the collection.
    //          Returns the next context if successful, otherwise returns the parentContext.
    private ConsoleContext readOrigin(GadgetCollection collection, int index) {
        if (index >= 0) {
            exploitObject = collection.get(index);

            if (exploitObject != null && collection.remove(index)) {
                return new ExploitObjectMover(getParentContext(), exploitObject, index);
            }
        }

        return getParentContext();
    }

    // MODIFIES: ((CollectionEditor) this.getParentContext()).getCollection()
    // EFFECTS: Attempts to insert exploitObject in the collection at the specified index.
    //          If unsuccessful, reinserts the exploitObject at the original index.
    //          Returns the parentContext.
    private ConsoleContext readDestination(GadgetCollection collection, int index) {
        if (index < 0 || !collection.add(exploitObject, index)) {
            collection.add(exploitObject, oldIndex);
        }

        return getParentContext();
    }
}
